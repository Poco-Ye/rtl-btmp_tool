;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/templates/image-explorer.soy' */
// This file was automatically generated from image-explorer.soy.
// Please don't edit this file by hand.

if (typeof Confluence == 'undefined') { var Confluence = {}; }
if (typeof Confluence.Templates == 'undefined') { Confluence.Templates = {}; }
if (typeof Confluence.Templates.AvatarPicker == 'undefined') { Confluence.Templates.AvatarPicker = {}; }


Confluence.Templates.AvatarPicker.imageExplorer = function(opt_data, opt_sb) {
  var output = opt_sb || new soy.StringBuilder();
  output.append('<div class="image-explorer-container ', (! opt_data.imageSrc) ? 'empty' : '', '"><div class="image-explorer-image-view"><img class="image-explorer-source" ', (opt_data.imageSrc) ? 'src="' + soy.$$escapeHtml(opt_data.imageSrc) + '"' : '', '/><div class="image-explorer-mask circle-mask"></div><div class="image-explorer-drag-delegate"></div></div><div class="image-explorer-scale-slider-wrapper"><input class="image-explorer-scale-slider ', (! opt_data.imageSrc) ? 'disabled' : '', '" type="range" min="0" max="100" step="1" value="0" ', (! opt_data.imageSrc) ? 'disabled' : '', '/></div></div>');
  return opt_sb ? '' : output.toString();
};


Confluence.Templates.AvatarPicker.iframeResponse = function(opt_data, opt_sb) {
  var output = opt_sb || new soy.StringBuilder();
  output.append('<html><body><div id="json-response">', opt_data.json, '</div></body></html>');
  return opt_sb ? '' : output.toString();
};

} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/templates/image-upload-and-crop.soy' */
// This file was automatically generated from image-upload-and-crop.soy.
// Please don't edit this file by hand.

if (typeof Confluence == 'undefined') { var Confluence = {}; }
if (typeof Confluence.Templates == 'undefined') { Confluence.Templates = {}; }
if (typeof Confluence.Templates.AvatarPicker == 'undefined') { Confluence.Templates.AvatarPicker = {}; }


Confluence.Templates.AvatarPicker.imageUploadAndCrop = function(opt_data, opt_sb) {
  var output = opt_sb || new soy.StringBuilder();
  output.append('<div class="image-upload-and-crop-message"></div><div class="image-upload-and-crop-container disable-attachment-uploader"><div class="input-fields"><form class="aui" onsubmit="return false;"><div class="field-group"><label for="avatar-picker-space-name">', soy.$$escapeHtml("Name"), '</label><input class="text long-field" type="text" id="avatar-picker-space-name" name="avatar-picker-space-name" title="Name" value="', soy.$$escapeHtml(opt_data.spaceName), '"/></div><div class="field-group"><label>', soy.$$escapeHtml("Space avatar"), '</label><div>');
  Confluence.Templates.AvatarPicker.imageExplorer(opt_data, output);
  output.append('</div></div></form></div><form class="aui"><div class="image-upload-and-crop-field-container buttons-container"><input type="file" id="image-upload-and-crop-upload-field" class="image-upload-field" accept="image/jpeg, image/gif, image/png"/><label for="image-upload-and-crop-upload-field" class="image-upload-field-replacement aui-button">', soy.$$escapeHtml("Upload an image"), '</label><button class="aui-button aui-button-link image-upload-and-crop-default-image" type="button">Restore default</button>', (opt_data.description) ? '<div class="description">' + soy.$$escapeHtml(opt_data.description) + '</div>' : '', (opt_data.fallbackDescription || opt_data.description) ? '<div class="description fallback">' + soy.$$escapeHtml(opt_data.fallbackDescription ? opt_data.fallbackDescription : opt_data.description) + '</div>' : '', '</div></form></div>');
  return opt_sb ? '' : output.toString();
};

} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/canvas-cropper.js' */
define("confluence-space-ia/avatar-picker/canvas-cropper",["jquery"],function(c){function b(e,d){if(!b.isSupported()){throw new Error("This browser doesn't support CanvasCropper.")}return this.init.apply(this,arguments)}var a=(function(){var d=document.createElement("canvas");return(typeof d.getContext==="function")&&d.getContext("2d")}());b.isSupported=function(){return a};b.prototype.defaults={outputFormat:"image/png",backgroundFillColor:undefined};b.prototype.init=function(e,d,f){this.width=e;this.height=d||e;this.options=c.extend({},this.defaults,f);this.canvas=c("<canvas/>").attr("width",this.width).attr("height",this.height)[0];return this};b.prototype.cropToDataURI=function(h,g,f,e,d){return this.crop(h,g,f,e,d).getDataURI(this.options.outputFormat)};b.prototype.crop=function(g,f,e,n,o){var d=this.canvas.getContext("2d"),l=0,j=0,k=this.width,h=this.height;d.clearRect(l,j,k,h);if(this.options.backgroundFillColor){d.fillStyle=this.options.backgroundFillColor;d.fillRect(l,j,k,h)}if(f<0){l=Math.round((Math.abs(f)/n)*k);f=0}if(e<0){j=Math.round((Math.abs(e)/o)*h);e=0}if(f+n>g.naturalWidth){var m=g.naturalWidth-f;k*=m/n;n=m}if(e+o>g.naturalHeight){var i=g.naturalHeight-e;h*=i/o;o=i}d.drawImage(g,f,e,n,o,l,j,k,h);return this};b.prototype.getDataURI=function(d){if(d){return this.canvas.toDataURL(d)}else{return null}};return b});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/client-file-handler.js' */
define("confluence-space-ia/avatar-picker/client-file-handler",["jquery","underscore"],function(c,b){function a(d){return this.init(d)}a.typeFilters={all:/.*/,application:/^application\/.*/,audio:/^audio\/.*/,image:/^image\/.*/,imageWeb:/^image\/(jpeg|png|gif)$/,text:/^text\/.*/,video:/^video\/.*/};a.prototype.defaults={fileTypeFilter:a.typeFilters.all,fileCountLimit:Infinity,fileSizeLimit:20*1024*1024,onSuccess:c.noop,onError:c.noop};a.prototype.init=function(d){this.options=c.extend({},this.defaults,d);if(d&&!d.fileSizeLimit){this.options.fileSizeLimit=this.defaults.fileSizeLimit}if(d&&!d.fileCountLimit){this.options.fileCountLimit=this.defaults.fileCountLimit}b.bindAll(this,"handleFiles","filterFiles");return this};a.prototype.handleFiles=function(f,e){var d=this.filterFiles(f);if(d.valid.length>0){b.isFunction(this.options.onSuccess)&&this.options.onSuccess(d.valid)}else{b.isFunction(this.options.onError)&&this.options.onError(d.invalid)}};a.prototype.filterFiles=function(e){var h=b.isRegExp(this.options.fileTypeFilter)?this.options.fileTypeFilter:this.defaults.fileTypeFilter,d=this.options.fileSizeLimit,g={byType:[],bySize:[],byCount:[]},f=b.filter(e,function(i){if(!h.test(i.type)){g.byType.push(i);return false}if(i.size>d){g.bySize.push(i);return false}return true});if(f.length>this.options.fileCountLimit){g.byCount=f.slice(this.options.fileCountLimit);f=f.slice(0,this.options.fileCountLimit)}return{valid:f,invalid:g}};return a});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/client-file-iframe-uploader.js' */
define("confluence-space-ia/avatar-picker/client-file-iframe-uploader",["jquery","underscore","confluence-space-ia/avatar-picker/client-file-handler"],function(d,b,a){function c(e){return this.init(e)}d.extend(c.prototype,a.prototype);c.prototype.defaults=d.extend({},a.prototype.defaults,{uploadURL:AJS.Meta.get("context-path")+"/rest/ia/1.0/space/defaultLogo",uploadFieldName:"file",onUpload:d.noop,responseHandler:function(g,h){var f;try{f=JSON.parse(d(g).html())}catch(i){h.reject()}if(f){h.resolve(f)}else{h.reject()}}});c.prototype.states={IN_PROGRESS:"IN_PROGRESS",IDLE:"IDLE"};c.prototype.init=function(e){b.bindAll(this,"createHiddenIframe","onIframeLoad","handleFiles","setStateInProgress","setStateIdle","cancelUpload");this.options=d.extend({},this.defaults,e);this.$uploadIframe=this.createHiddenIframe();if(this.options.cancelTrigger){this.$cancelTrigger=d(this.options.cancelTrigger);this.$cancelTrigger.click(b.bind(function(){this.cancelUpload()},this))}this.state=this.states.IDLE;return this};c.prototype.createHiddenIframe=function(){return d("<iframe>").attr("name","hidden-upload-iframe").hide().appendTo(document.body).on("load",this.onIframeLoad)};c.prototype.onIframeLoad=function(f){if(this.state===this.states.IN_PROGRESS){this.requestPromise.done(this.options.onUpload).fail(this.options.onError);this.options.responseHandler(f.target.contentDocument.body,this.requestPromise)}};c.prototype.handleFiles=function(f,e){if(this.state===this.states.IN_PROGRESS){this.cancelUpload()}if(!this.$fileSourceElem){this.$fileSourceElem=d(e);this.$fileSourceElem.attr("name",this.options.uploadFieldName);if(!this.$fileSourceElem.prop("form")){this.$fileSourceElem.wrap("<form>")}var g=d(this.$fileSourceElem.prop("form"));g.addClass("hidden-upload-form").attr("action",this.options.uploadURL).attr("method","post").attr("enctype","multipart/form-data").attr("encoding","multipart/form-data").attr("target",this.$uploadIframe.attr("name"));this.$spinner=d('<div class="spinner"></div>').insertBefore(this.$fileSourceElem);if(d.isPlainObject(this.options.extraData)){b.each(this.options.extraData,function(i,h){d('<input type="hidden">').attr("name",h).val(i).appendTo(g)})}}this.$fileSourceElem.prop("form").submit();this.requestPromise=d.Deferred();this.requestPromise.always(this.setStateIdle);this.setStateInProgress()};c.prototype.setStateInProgress=function(){this.state=this.states.IN_PROGRESS;if(this.$spinner){this.$spinner.spin()}if(this.$fileSourceElem){this.$fileSourceElem.attr("disabled","disabled")}};c.prototype.setStateIdle=function(){this.state=this.states.IDLE;if(this.$spinner){this.$spinner.spinStop()}if(this.$fileSourceElem){this.$fileSourceElem.removeAttr("disabled")}this.requestPromise=null};c.prototype.cancelUpload=function(){this.$uploadIframe.remove();this.setStateIdle();this.$uploadIframe=this.createHiddenIframe()};return c});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/client-file-reader.js' */
define("confluence-space-ia/avatar-picker/client-file-reader",["jquery","underscore","confluence-space-ia/avatar-picker/client-file-handler"],function(e,d,b){var f=!!(window.File&&window.FileList&&window.FileReader);var c={ArrayBuffer:"readAsArrayBuffer",BinaryString:"readAsBinaryString",DataURL:"readAsDataURL",Text:"readAsText"};function a(g){if(!a.isSupported()){throw new Error("ClientFileReader requires FileReaderAPI support")}return this.init(g)}a.isSupported=function(){return f};e.extend(a.prototype,b.prototype);a.readMethods={ArrayBuffer:"ArrayBuffer",BinaryString:"BinaryString",DataURL:"DataURL",Text:"Text"};a.typeFilters=b.typeFilters;a.prototype.defaults=e.extend({},b.prototype.defaults,{readMethod:a.readMethods.DataURL,onRead:e.noop});a.prototype.init=function(g){b.prototype.init.call(this,g);d.bindAll(this,"onSuccess","readFile");this.options.onSuccess=this.onSuccess;return this};a.prototype.onSuccess=function(h){var g=d.has(c,this.options.readMethod)?c[this.options.readMethod]:undefined;if(g){d.each(h,d.bind(function(j){var i=new FileReader();i.onload=d.bind(this.readFile,this,j);i[g](j)},this))}};a.prototype.readFile=function(g,h){d.isFunction(this.options.onRead)&&this.options.onRead(h.target.result,g)};return a});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/drag-drop-file-target.js' */
define("confluence-space-ia/avatar-picker/drag-drop-file-target",["jquery","underscore"],function(c,a){function b(d,e){return this.init.apply(this,arguments)}b.prototype.getDefaults=function(){return{activeDropTargetClass:"active-drop-target",uploadPrompt:"Drag an image here",clientFileHandler:null}};b.prototype.init=function(d,e){a.bindAll(this,"onDragOver","onDragEnd","onDrop");this.$target=c(d);this.options=c.extend({},this.getDefaults(),e);this.$target.attr("data-upload-prompt",this.options.uploadPrompt);this.$target.on("dragover",this.onDragOver);this.$target.on("dragleave",this.onDragEnd);this.$target.on("dragend",this.onDragEnd);this.$target.on("drop",this.onDrop)};b.prototype.onDragOver=function(d){d.preventDefault();this.$target.addClass(this.options.activeDropTargetClass)};b.prototype.onDragEnd=function(d){d.preventDefault();this.$target.removeClass(this.options.activeDropTargetClass)};b.prototype.onDrop=function(d){d.preventDefault();d.originalEvent.preventDefault();this.$target.removeClass(this.options.activeDropTargetClass);if(this.options.clientFileHandler){this.options.clientFileHandler.handleFiles(d.originalEvent.dataTransfer.files,d.originalEvent.target)}};return b});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/image-explorer.js' */
define("confluence-space-ia/avatar-picker/image-explorer",["jquery","underscore","confluence-space-ia/avatar-picker/fd-slider"],function(c,a,b){function d(f,e){this.init.apply(this,arguments)}d.scaleModes={fill:"fill",contain:"contain",containAndFill:"containAndFill"};d.zoomModes={localZoom:"localZoom",imageZoom:"imageZoom"};d.prototype.defaults={initialScaleMode:d.scaleModes.containAndFill,zoomMode:d.zoomModes.localZoom,emptyClass:"empty",scaleMax:1};d.prototype.init=function(f,e){this.$container=f;this.$imageView=this.$container.find(".image-explorer-image-view");this.$sourceImage=this.$container.find(".image-explorer-source");this.$mask=this.$container.find(".image-explorer-mask");this.$dragDelegate=this.$container.find(".image-explorer-drag-delegate");this.$scaleSlider=this.$container.find(".image-explorer-scale-slider");this.options=c.extend({},this.defaults,e);this.imageProperties={};a.bindAll(this,"getImageSrc","setImageSrc","initImage","initDragDelegate","initScaleSlider","setInitialScale","getFillScale","getContainedScale","getCircularContainedScale","sliderValToScale","scaleToSliderVal","updateImageScale","resetImagePosition","resetScaleSlider","toggleEmpty","get$ImageView","get$SourceImage","get$Mask","get$DragDelegate","getMaskedImageProperties","showError","clearError","hasValidImage","_resetFromError","_removeError");this.toggleEmpty(true);if(this.$sourceImage[0].naturalWidth){this.toggleEmpty(false);this.initImage({target:this.$sourceImage[0]})}this.$sourceImage.on("load",this.initImage);this.initDragDelegate();this.initScaleSlider()};d.prototype.getImageSrc=function(){return(this.$sourceImage)?this.$sourceImage.attr("src"):undefined};d.prototype.setImageSrc=function(e){if(this.$sourceImage){this.$sourceImage.attr("src","").attr("src",e)}};d.prototype.initImage=function(g){var f=g.target;this.imageProperties.naturalWidth=f.naturalWidth;this.imageProperties.naturalHeight=f.naturalHeight;this._removeError();this.toggleEmpty(false);this.setInitialScale()};d.prototype.initDragDelegate=function(){var e;this.$dragDelegate.draggable({start:a.bind(function(){e=this.$sourceImage.offset()},this),drag:a.bind(function(g,f){this.$sourceImage.offset({top:e.top+f.position.top-f.originalPosition.top,left:e.left+f.position.left-f.originalPosition.left})},this),revert:true,revertDuration:0})};d.prototype.initScaleSlider=function(){this.$scaleSlider.on("change",a.bind(function(f){this.updateImageScale(this.sliderValToScale(f.target.value))},this))};d.prototype.setInitialScale=function(){var i=this.$mask.width(),g=this.$mask.height(),f=this.imageProperties.naturalWidth,h=this.imageProperties.naturalHeight,e=1;this.minScale=1;switch(this.options.initialScaleMode){case d.scaleModes.fill:this.minScale=e=this.getFillScale(f,h,i,g);break;case d.scaleModes.contain:if(this.$mask.hasClass("circle-mask")){this.minScale=e=this.getCircularContainedScale(f,h,i/2)}else{this.minScale=e=this.getContainedScale(f,h,i,g)}break;case d.scaleModes.containAndFill:if(this.$mask.hasClass("circle-mask")){this.minScale=this.getCircularContainedScale(f,h,i/2)}else{this.minScale=this.getContainedScale(f,h,i,g)}e=this.getFillScale(f,h,i,g);break}this.maxScale=Math.max(e,this.options.scaleMax);this.resetScaleSlider(this.scaleToSliderVal(e));this.updateImageScale(e,d.zoomModes.imageZoom);this.resetImagePosition()};d.prototype.getFillScale=function(g,e,f,j){var i=f/g,h=j/e;return Math.max(i,h)};d.prototype.getContainedScale=function(g,e,f,j){var i=f/g,h=j/e;return Math.min(i,h)};d.prototype.getCircularContainedScale=function(f,e,i){var h=Math.atan(e/f),g=Math.cos(h)*i*2;return g/f};d.prototype.sliderValToScale=function(f){var e=f/(this.$scaleSlider.attr("max")-this.$scaleSlider.attr("min"));return this.minScale+(e*(this.maxScale-this.minScale))};d.prototype.scaleToSliderVal=function(f){var e=(f-this.minScale)/(this.maxScale-this.minScale);return e*(this.$scaleSlider.attr("max")-this.$scaleSlider.attr("min"))};d.prototype.updateImageScale=function(k,m){var j=Math.round(k*this.imageProperties.naturalWidth),e=Math.round(k*this.imageProperties.naturalHeight),g,f;m=m||this.options.zoomMode;switch(m){case d.zoomModes.imageZoom:g=-1*j/2;f=-1*e/2;break;case d.zoomModes.localZoom:var i=this.$sourceImage.width(),s=this.$sourceImage.height(),o=parseInt(this.$sourceImage.css("margin-left"),10),h=parseInt(this.$sourceImage.css("margin-top"),10),r=this.$sourceImage.position(),q=this.$imageView.width()/2,p=this.$imageView.height()/2,n=q-r.left-o,l=p-r.top-h,u=(n/i)*j,t=(l/s)*e;g=q-r.left-u;f=p-r.top-t;break}this.$sourceImage.width(j).height(e).css({"margin-left":Math.round(g)+"px","margin-top":Math.round(f)+"px"})};d.prototype.resetImagePosition=function(){this.$sourceImage.css({top:"50%",left:"50%"})};d.prototype.resetScaleSlider=function(e){this.$scaleSlider.val(e).removeClass("disabled").removeAttr("disabled");b.updateSlider(this.$scaleSlider.attr("id"))};d.prototype.toggleEmpty=function(e){this.$container.toggleClass(this.options.emptyClass,e)};d.prototype.get$ImageView=function(){return this.$imageView};d.prototype.get$SourceImage=function(){return this.$sourceImage};d.prototype.get$Mask=function(){return this.$mask};d.prototype.get$DragDelegate=function(){return this.$dragDelegate};d.prototype.getMaskedImageProperties=function(){var g=this.$sourceImage.width()/this.imageProperties.naturalWidth,f=this.$sourceImage.height()/this.imageProperties.naturalHeight,e=this.$mask.position(),h=this.$sourceImage.position();e.top+=parseInt(this.$mask.css("margin-top"),10);e.left+=parseInt(this.$mask.css("margin-left"),10);h.top+=parseInt(this.$sourceImage.css("margin-top"),10);h.left+=parseInt(this.$sourceImage.css("margin-left"),10);return{maskedAreaImageX:Math.round((e.left-h.left)/g),maskedAreaImageY:Math.round((e.top-h.top)/f),maskedAreaWidth:Math.round(this.$mask.width()/g),maskedAreaHeight:Math.round(this.$mask.height()/f)}};d.prototype.showError=function(g,f){this._removeError();this.toggleEmpty(true);this.$container.addClass("error");var e=c(aui.message.error({titleContent:g,content:f||"",closeable:true}));e.appendTo(this.$imageView).css({"margin-top":-1*e.outerHeight()/2}).attr("id","upload-error-message");e.on("messageClose",this._resetFromError);AJS.messages.setup()};d.prototype.clearError=function(){this._removeError();this._resetFromError()};d.prototype.hasValidImage=function(){return !!(this.getImageSrc()&&this.$sourceImage.prop("naturalWidth"))};d.prototype._resetFromError=function(){var e=this.hasValidImage();this.toggleEmpty(!e);this.$container.removeClass("error");a.isFunction(this.options.onErrorReset)&&this.options.onErrorReset(e?this.getImageSrc():undefined)};d.prototype._removeError=function(){this.$imageView.find(".aui-message.error").remove()};return d});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/image-upload-and-crop.js' */
define("confluence-space-ia/avatar-picker/image-upload-and-crop",["jquery","underscore","confluence-space-ia/avatar-picker/image-explorer","confluence-space-ia/avatar-picker/client-file-reader","confluence-space-ia/avatar-picker/drag-drop-file-target","confluence-space-ia/avatar-picker/client-file-iframe-uploader","confluence-space-ia/avatar-picker/upload-interceptor","confluence-space-ia/avatar-picker/canvas-cropper","confluence-space-ia/avatar-picker/text-util"],function(e,h,j,f,g,i,a,b,d){function c(l,k){if(!c.isSupported()){throw new Error("This browser doesn't support ImageUploadAndCrop.")}this.init.apply(this,arguments)}c.isSupported=function(){return b.isSupported()};c.prototype.defaults={HiDPIMultiplier:2,dragDropUploadPrompt:"Drag an image here",onImageUpload:e.noop,onImageUploadError:e.noop,onCrop:e.noop,outputFormat:"image/png",fallbackUploadOptions:{},initialScaleMode:j.scaleModes.containAndFill,scaleMax:1,fileSizeLimit:5*1024*1024,maxImageDimension:2000};c.prototype.init=function(n,m){this.options=e.extend({},this.defaults,m);this.$container=n;this.$imageContainer=n.find(".image-explorer-image-view");h.bindAll(this,"crop","resetState","_onFileProcessed","setImageSrc","validateImageResolution","_onFilesError","_onFileError","_resetFileUploadField","_onErrorReset");this.imageExplorer=new j(this.$container.find(".image-explorer-container"),{initialScaleMode:this.options.initialScaleMode,scaleMax:this.options.scaleMax,onErrorReset:this._onErrorReset});if(f.isSupported()){this.clientFileReader=new f({onRead:this._onFileProcessed,onError:this._onFilesError,fileTypeFilter:f.typeFilters.imageWeb,fileCountLimit:1,fileSizeLimit:this.options.fileSizeLimit});this.dragDropFileTarget=new g(this.imageExplorer.get$ImageView(),{uploadPrompt:this.options.dragDropUploadPrompt,clientFileHandler:this.clientFileReader})}else{this.$container.addClass("filereader-unsupported");var l=e.extend({onUpload:this._onFileProcessed,onError:this._onFileError},this.options.fallbackUploadOptions);this.clientFileReader=new i(l)}this.uploadIntercepter=new a(this.$container.find(".image-upload-field"),{replacementEl:this.$container.find(".image-upload-field-replacement"),clientFileHandler:this.clientFileReader});var k=this.imageExplorer.get$Mask();this.canvasCroppper=new b(k.width()*this.options.HiDPIMultiplier,k.height()*this.options.HiDPIMultiplier,{outputFormat:this.options.outputFormat});this.options.cropButton&&e(this.options.cropButton).click(this.crop)};c.prototype.crop=function(){var k="";if(!this.imageExplorer.$container.hasClass("empty")){var l=this.imageExplorer.getMaskedImageProperties();k=this.canvasCroppper.cropToDataURI(this.imageExplorer.get$SourceImage()[0],l.maskedAreaImageX,l.maskedAreaImageY,l.maskedAreaWidth,l.maskedAreaHeight)}h.isFunction(this.options.onCrop)&&this.options.onCrop(k)};c.prototype.resetState=function(){this.imageExplorer.clearError();this._resetFileUploadField()};c.prototype.saveState=function(){if(this.imageExplorer.$container.hasClass("empty")){return}var k=this.imageExplorer.get$SourceImage();if(k.length){this.imageState={top:k.css("top"),left:k.css("left"),marginTop:k.css("margin-top"),marginLeft:k.css("margin-left"),zoom:e(".image-explorer-scale-slider").val()}}};c.prototype.restoreState=function(){if(this.imageExplorer.$container.hasClass("empty")||!this.imageState){return}var k=this.imageExplorer.get$SourceImage();if(k.length){this.imageExplorer.$scaleSlider.val(this.imageState.zoom).trigger("change");k.css({top:this.imageState.top,left:this.imageState.left,"margin-top":this.imageState.marginTop,"margin-left":this.imageState.marginLeft})}};c.prototype._renderSpinner=function(){this.$imageContainer.removeAttr("data-upload-prompt");this.$imageContainer.append("<div class='throbber'></div>");this.throbber=AJS.$(".image-explorer-image-view .throbber");AJS.$(".throbber").spin("large")};c.prototype._hideSpinner=function(){AJS.$(".throbber").spinStop();this.throbber.addClass("hidden")};c.prototype._onFileProcessed=function(l){e("#avatar-picker-dialog .image-upload-and-crop-message").hide();this._renderSpinner();if(l){if(!isNaN(this.options.maxImageDimension)){var k=this.validateImageResolution(l);k.done(h.bind(function(n,m){this.setImageSrc(l);AJS.$("#avatar-picker-dialog .aui-button-primary").removeAttr("disable")},this)).fail(h.bind(function(n,m){this._onFileError(AJS.format("The selected image size is {0}px * {1}px. The maximum allowed image size is {2}px * {2}px",n,m,this.options.maxImageDimension))},this)).always(h.bind(function(){this._hideSpinner()},this))}else{this.setImageSrc(l)}}else{this._onFileError()}};c.prototype.setImageSrc=function(k){this.imageExplorer.setImageSrc(k);h.isFunction(this.options.onImageUpload)&&this.options.onImageUpload(k);this._resetFileUploadField()};c.prototype.validateImageResolution=function(n){var k=e.Deferred(),m=new Image(),l=this;m.onload=function(){if(this.naturalWidth>l.options.maxImageDimension||this.naturalHeight>l.options.maxImageDimension){k.reject(this.naturalWidth,this.naturalHeight)}else{k.resolve(this.naturalWidth,this.naturalHeight)}};m.src=n;return k};c.prototype._onFilesError=function(l){if(l&&l.bySize&&l.bySize.length){var k=h.first(l.bySize);this._onFileError(AJS.format("File \"{0}\" is {1} which is larger than the maximum allowed size of {2}",d.abbreviateText(k.name,50),d.formatSizeInBytes(k.size),d.formatSizeInBytes(this.options.fileSizeLimit)))}else{this._onFileError()}};c.prototype._onFileError=function(k){var m="There was an error uploading your image",l=k||"Please check that your file is a valid image and try again.";this.imageExplorer.showError(m,l);this._resetFileUploadField();e("#avatar-picker-dialog .image-upload-and-crop-message").hide();h.isFunction(this.options.onImageUploadError)&&this.options.onImageUploadError(k)};c.prototype._resetFileUploadField=function(){var k=this.$container.find("#image-upload-and-crop-upload-field").prop("form");k&&k.reset()};c.prototype._onErrorReset=function(k){if(k){h.isFunction(this.options.onImageUpload)&&this.options.onImageUpload(k)}};return c});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/text-util.js' */
define("confluence-space-ia/avatar-picker/text-util",[],function(){return{formatSizeInBytes:function(d){var b=[" bytes","KB","MB","GB","TB","PB"],c=1024,a=0,e=b.length-1;d=(typeof d==="number")?d:parseInt(d,10);if(isNaN(d)){return""}while(d>=c&&a<e){d/=c;a++}d=Math.floor((d*10))/10;return d+b[a]},abbreviateText:function(f,a,e){if(typeof f!=="string"){return undefined}if(isNaN(a)||a<0||f.length<=a){return f}var c=(typeof e==="string")?e:"…",b=f.length-a+c.length,d=Math.round(f.length/2);return f.substring(0,d-Math.ceil(b/2))+c+f.substring(d+Math.floor(b/2),f.length)}}});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/upload-interceptor.js' */
define("confluence-space-ia/avatar-picker/upload-interceptor",["jquery","underscore"],function(c,a){function b(d,e){return this.init.apply(this,arguments)}b.prototype.defaults={replacementEl:undefined,clientFileHandler:null};b.prototype.init=function(d,e){a.bindAll(this,"onSelectFile","onReplacementClick");this.$el=c(d);this.options=c.extend({},this.defaults,e);this.$el.on("change",this.onSelectFile);if(this.options.replacementEl){this.$replacement=c(this.options.replacementEl);this.$el.hide();if(c.browser&&c.browser.msie){if(!this.$replacement.is("label")){this.$replacement.hide();this.$el.show()}}else{this.$replacement.on("click",this.onReplacementClick)}}};b.prototype.onSelectFile=function(d){if(c(d.target).val()&&this.options.clientFileHandler){this.options.clientFileHandler.handleFiles(d.target.files,this.$el)}};b.prototype.onReplacementClick=function(d){d.preventDefault();this.$el.click()};b.prototype.destroy=function(){this.$el.off("change",this.onSelectFile);this.$replacement.off("click",this.onReplacementClick)};return b});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
;try {
/* module-key = 'com.atlassian.confluence.plugins.confluence-space-ia:avatar-picker', location = 'avatar-picker/js/avatar-picker-dialog.js' */
define("confluence-space-ia/avatar-picker/avatar-picker-dialog",["jquery","underscore","confluence-space-ia/avatar-picker/image-upload-and-crop","confluence-space-ia/avatar-picker/text-util"],function(c,a,e,b){function d(f){if(!d.isSupported()){throw new Error("This browser doesn't support AvatarPickerDialog.")}return this.init(f)}d.isSupported=function(){return e.isSupported()};d.prototype.defaults={dialogTitle:"Space details",dialogOptions:{width:445,height:537,id:"avatar-picker-dialog",closeOnOutsideClick:false},onCrop:c.noop,trigger:null,expandedClass:"expanded"};d.prototype.init=function(f){a.bindAll(this,"initDialogContent","_onImageUpload","_onImageUploadError","_toggleSaveButtonEnabled","chooseAvatar","_onUpdateSpaceDetails","hide","show","cancel");this.options=c.extend(true,{},this.defaults,f);this.$dialog=new AJS.Dialog(this.options.dialogOptions);this.initDialogContent();this.imageUploadAndCrop=new e(this.$dialog.getCurrentPanel().body.find(".image-upload-and-crop-container"),{HiDPIMultiplier:1,onCrop:this._onUpdateSpaceDetails,onImageUpload:this._onImageUpload,onImageUploadError:this._onImageUploadError,fallbackUploadOptions:{uploadURL:AJS.Meta.get("context-path")+"/rest/ia/1.0/space/uploadLogo",uploadFieldName:"upload-logo-input",responseHandler:function(k,l){var j=c(k),i=j.find("#json-response");if(i.length){var h;try{h=JSON.parse(i.html())}catch(m){l.reject()}if(h&&h.src){l.resolve(AJS.Meta.get("context-path")+h.src)}else{l.reject(h&&h.errorMessages&&h.errorMessages[0])}}else{var g=j.find(".error-image + h2").text();g=g.replace(/; nested exception.*$/,".").replace(/(\d+) bytes/,function(n,o){return b.formatSizeInBytes(o)});l.reject(g)}},cancelTrigger:this.$saveButton.add(this.$cancelButton)}});this.$spaceNameField.closest("form").on("submit",this.chooseAvatar);if(this.options.trigger){this.$trigger=c(this.options.trigger);this.$trigger.click(a.bind(function(g){g.preventDefault();this.show()},this))}return this};d.prototype.initDialogContent=function(){this.$dialog.addHeader(this.options.dialogTitle).addPanel().addSubmit("Save",this.chooseAvatar).addCancel("Cancel",this.cancel).getCurrentPanel().body.append(Confluence.Templates.AvatarPicker.imageUploadAndCrop({spaceName:AJS.Meta.get("space-name"),description:"JPG, GIF or PNG image",fallbackDescription:"JPG, GIF or PNG image"}));this.$saveButton=this.$dialog.getCurrentPanel().page.buttonpanel.find(".button-panel-submit-button");this.$cancelButton=this.$dialog.getCurrentPanel().page.buttonpanel.find(".button-panel-cancel-link");this.$spaceNameField=this.$dialog.getCurrentPanel().page.body.find("#avatar-picker-space-name");this.$message=this.$dialog.getCurrentPanel().page.body.find(".image-upload-and-crop-message");this.$useDefault=this.$dialog.getCurrentPanel().page.body.find(".image-upload-and-crop-default-image");this.$useDefault.click(a.bind(function(){c.ajax({type:"GET",dataType:"json",contentType:"application/json",url:AJS.Meta.get("context-path")+"/rest/ia/1.0/space/defaultLogo",success:a.bind(function(f){this.imageUploadAndCrop.setImageSrc(AJS.Meta.get("context-path")+f.logoDownloadPath)},this)})},this))};d.prototype._onUpdateSpaceDetails=function(f){this.options.onCrop(f,this.$spaceNameField.val())};d.prototype._onImageUpload=function(){this._toggleExpanded(true);this._toggleSaveButtonEnabled(true)};d.prototype._onImageUploadError=function(){this._toggleExpanded(false);this._toggleSaveButtonEnabled(false)};d.prototype._toggleSaveButtonEnabled=function(f){if(f===null){f=this.$saveButton.attr("disabled")!==null}if(f){this.$saveButton.removeAttr("disabled")}else{this.$saveButton.attr("disabled","disabled")}};d.prototype._turnSaveButtonIntoPrimary=function(){this.$saveButton.removeClass("button-panel-button").addClass("aui-button aui-button-primary")};d.prototype._removeSaveImageLoadingIcon=function(){c("#avatar-picker-dialog .aui-icon-wait").remove()};d.prototype.chooseAvatar=function(){this._toggleSaveButtonEnabled(false);this.$saveButton.before("<span class='aui-icon aui-icon-wait'/>");this.imageUploadAndCrop.crop()};d.prototype.hide=function(){this.hideMessage();this.$dialog.hide();this.imageUploadAndCrop.resetState()};d.prototype.cancel=function(){this.imageUploadAndCrop.restoreState();this.hide()};d.prototype.show=function(f){if(f){this.$spaceNameField.val(f)}this.imageUploadAndCrop.saveState();this.$dialog.show();this._turnSaveButtonIntoPrimary();this._removeSaveImageLoadingIcon()};d.prototype.setMessage=function(f){this.$message.html(aui.message.error({content:f,closeable:false})).show()};d.prototype.hideMessage=function(){this.$message.hide()};d.prototype._toggleExpanded=function(f){AJS.$("#avatar-picker-dialog").toggleClass(this.options.expandedClass,f)};return d});
} catch (err) {
    if (console && console.log && console.error) {
        console.log("Error running batched script.");
        console.error(err);
    }
}

;
